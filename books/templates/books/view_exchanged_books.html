{% extends "layout.html" %}
{% block body_class %}exchanged-books-page{% endblock %}

{% block content %}
<header class="login-header">
    <a href="{% url 'Home' %}" class="back-arrow">
        <span class="material-icons">arrow_back</span>
    </a>

    <div class="login-logo">
        <img src="/media/images/website_logo.png" alt="BookLoop">
    </div>
    <div class="header-actions">
        {% if user.is_authenticated %}
            <a href="{% url 'profile' %}" class="profile-icon">
                <span class="material-icons">account_circle</span>
            </a>

            <a href="{% url 'Logout' %}" class="btn login-btn">
                Logout
            </a>
        {% endif %}
    </div>
</header>

<div class="container my-3 mx-5">

<h3 class="mb-4">My Exchanged Books</h3>

{% for r in exchanges %}

<div class="exchange-card p-4 mb-3">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <div class="exchange-title">
                {{ r.book.title }}
            </div>

            <!-- Exchange Date -->
            <div class="exchange-meta mt-1">
                Exchanged on {{ r.created_at|date:"d M Y" }}
            </div>
        </div>

        <span class="badge bg-success exchange-badge-sm">Completed</span>
    </div>

    <div class="exchange-divider"></div>

    <!-- Book Thumbnails -->
    <!-- Book / Exchange Visual -->
    {% if r.is_cash %}

        <!-- CASH EXCHANGE -->
        <div class="exchange-books justify-content-center">

            <div class="exchange-book">
                <img src="{{ r.book.cover_image.url|default:'/media/images/book-cover.png' }}"
                    alt="{{ r.book.title }}">
                <div class="exchange-book-title">{{ r.book.title }}</div>
                <div class="exchange-meta mt-1">
                    Sold for â‚¹{{ r.cash_amount }}
                </div>
            </div>

        </div>

    {% else %}

        <!-- BOOK â†” BOOK EXCHANGE -->
        <div class="exchange-books">

            <div class="exchange-book">
                <img src="{{ r.book.cover_image.url|default:'/media/images/book-cover.png' }}"
                    alt="{{ r.book.title }}">
                <div class="exchange-book-title">{{ r.book.title }}</div>
            </div>

            <div class="exchange-icon">ðŸ”„</div>

            <div class="exchange-book">
                <img src="{{ r.expected_book.cover_image.url|default:'/media/images/book-cover.png' }}"
                    alt="{{ r.expected_book.title }}">
                <div class="exchange-book-title">{{ r.expected_book.title }}</div>
            </div>

        </div>

    {% endif %}

    <!-- Role-based details -->
    {% if user == r.owner %}
        <!-- OWNER VIEW -->
        {% if r.is_cash %}
            <div class="exchange-meta">
                Sold for <strong>â‚¹{{ r.cash_amount }}</strong>
            </div>
        {% else %}
            <div class="exchange-meta">
                Exchanged for <strong>{{ r.expected_book.title }}</strong>
            </div>
    {% endif %}

    <div class="d-flex align-items-center gap-2 mt-2">

        {% if r.requester.profile.avatar %}
            <img src="{{ r.requester.profile.avatar.url }}"
                 class="avatar shadow-sm"
                 alt="{{ r.requester.username }}">
        {% else %}
            <div class="avatar placeholder-avatar d-flex align-items-center justify-content-center">
                <span class="material-icons text-muted">person</span>
            </div>
        {% endif %}
    
        <div class="exchange-meta">
            {% if r.is_cash %}
                Sold to <strong>{{ r.requester.username }}</strong>
            {% else %}
                Exchanged with <strong>{{ r.requester.username }}</strong>
            {% endif %}
        </div>
    
    </div>    

    <div class="exchange-contact mt-2">
        Contact: {{ r.requester.email }} | {{ r.requester.profile.phone }}
    </div>

    {% if not r.is_cash and r.expected_book %}
        <a href="{% url 'book_detail' r.expected_book.slug %}" class="primary-btn mt-3">
            View Received Book
        </a>
    {% endif %}


    {% else %}
        <!-- REQUESTER VIEW -->
        {% if r.is_cash %}
            <div class="exchange-meta">
                Purchased for <strong>â‚¹{{ r.cash_amount }}</strong>
            </div>
        {% else %}
            <div class="exchange-meta">
                Traded your copy of <strong>{{ r.expected_book.title }}</strong>
            </div>
        {% endif %}

        <div class="d-flex align-items-center gap-2 mt-2">

            {% if r.owner.profile.avatar %}
                <img src="{{ r.owner.profile.avatar.url }}"
                     class="avatar shadow-sm"
                     alt="{{ r.owner.username }}">
            {% else %}
                <div class="avatar placeholder-avatar d-flex align-items-center justify-content-center">
                    <span class="material-icons text-muted">person</span>
                </div>
            {% endif %}
        
            <div class="exchange-meta">
                {% if r.is_cash %}
                    Purchased from <strong>{{ r.owner.username }}</strong>
                {% else %}
                    Exchanged with <strong>{{ r.owner.username }}</strong>
                {% endif %}
            </div>
        
        </div>

        <div class="exchange-contact mt-2">
            Contact: {{ r.owner.email }} | {{ r.owner.profile.phone }}
        </div>

        {% if r.book.condition %}
            <div class="exchange-meta mt-1">
                Condition: {{ r.book.condition }}
            </div>
        {% endif %}

        {% if r.book %}
            <a href="{% url 'book_detail' r.book.slug %}" class="primary-btn mt-3">
                View Book
            </a>
        {% endif %}


    {% endif %}

</div>

{% empty %}
<p>No exchanged books yet.</p>

{% endfor %}
</div>

{% endblock %}
